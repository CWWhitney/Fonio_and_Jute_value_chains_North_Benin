---
title: "Value Chain Prioritization"
output: html_document
date: "`r format(Sys.Date(), '%B %d, %Y')`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(tidyverse)
library(plotly)
library(ggrepel)
```

Experts identified the interventions and the objectives and then voted on the impact of each. They voted with cards representing three options, 1=low, 2=middle, and 3=high impact. We converted all responses to Percentage of Maximum Possible (POMP) scoring as applied in Participatory Rural Appraisal (PRA), community-based monitoring systems, stakeholder engagement metrics and consensus measurement in deliberative democracy. 

```{r data}
# Load the transposed matrix
# unified_matrix <- read_csv("data/interventions_matrix.csv")
unified_matrix_fonio_all <- read_csv("data/fonio_data/interventions_matrix_all.csv")
total_participants <- 55
high_vote_score <- 3
max_possible_per_intervention <- total_participants * high_vote_score 
normalized_matrix_fonio_all <- unified_matrix_fonio_all %>%
  # For score rows only, normalize across intervention columns
  mutate(across(5:13, 
                ~ ifelse(type == "score", 
                        (.x / max_possible_per_intervention) * 10,  # Convert to 1-10 scale
                        .x)))  # Keep weight rows as-is

unified_matrix_fonio_men_boukoumbe <- read_csv("data/fonio_data/interventions_matrix_men_boukoumbe.csv")

unified_matrix_fonio_men_natitingou <- read_csv("data/fonio_data/interventions_matrix_men_natitingou.csv")

unified_matrix_fonio_women_boukoumbe <- read_csv("data/fonio_data/interventions_matrix_women_boukoumbe.csv")

unified_matrix_fonio_women_natitingou <- read_csv("data/fonio_data/interventions_matrix_women_natitingou.csv")

unified_matrix = normalized_matrix_fonio_all

# Scores were done with 1-3 votes - people who did not vote could have indicated that they are a '0' no confidence, or a 'na' that they either did not understand or did not agree. So that the total score could potentially range from n to n*3 participants. 
```

Step 1: Impact Assessment Matrix
Rate expected impact of each intervention (1-10 scale)
*10 = Very high impact, 5 = Moderate impact, 1 = No impact*

```{r unified_matrix, echo=FALSE}
# Extract objective weights and category definitions
objective_weights <- unified_matrix %>%
  filter(type == "score") %>%
  select(objective, category, weight)

# Extract intervention scores
score_matrix <- unified_matrix %>%
  filter(type == "score") %>%
  select(-type, -category, -weight)

# Calculate weighted scores 
results <- score_matrix %>%
  pivot_longer(cols = -objective, names_to = "intervention", values_to = "score") %>%
  left_join(objective_weights, by = "objective") %>%  # join by objective
  # group_by(category) %>%
  # mutate(weight_normalized = weight / sum(weight)) %>%
  # ungroup() %>%
  mutate(weighted_score = score * weight/100) %>% 
  group_by(intervention, category) %>%
  summarise(
    category_score = sum(weighted_score),
    .groups = "drop"
  ) %>%
  pivot_wider(names_from = category, values_from = category_score) %>%
  mutate(total_score = impact + feasibility) %>%
  arrange(desc(total_score))

# Prepare data for heatmap
full_heatmap_data <- unified_matrix %>%
  mutate(label = case_when(
    type == "weight" ~ "PRIORITY WEIGHTS",
    type == "score" ~ objective
  ))

intervention_cols <- setdiff(names(full_heatmap_data), 
                         c("type", "objective", "category", "label"))

full_heatmap_data <- full_heatmap_data %>%
  select(label, all_of(intervention_cols)) %>%
  pivot_longer(cols = -label, names_to = "intervention", values_to = "score") %>%
  mutate(score_display = ifelse(label == "PRIORITY WEIGHTS", score, score))
```


Comprehensive Impact Matrix Heatmap

This shows the complete assessment - both the stakeholder priorities (weights) and intervention impacts.


```{r heatmap_display_data, echo=FALSE}
# Filter out the priority weights row for the heatmap
heatmap_display_data <- full_heatmap_data %>%
  filter(label != "PRIORITY WEIGHTS") 

ggplot(heatmap_display_data, aes(x = intervention, y = label, fill = score_display)) +
  geom_tile(color = "white", size = 1) +
  geom_text(aes(label = round(score_display, 1)), color = "black", size = 4) +
  scale_fill_gradient2(low = "white", high = "green", 
                      midpoint = 5, name = "Score") +
  labs(title = "Intervention Impact Matrix",
       subtitle = "Scores show expected impact (sum of votes) on each objective",
       x = "Interventions", y = "Objectives") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        plot.title = element_text(face = "bold"),
        panel.grid = element_blank())

```

# Bubble Chart - "Impact vs Feasibility (Weighted Composite)"

This chart shows the relationship between impact and feasibility for each intervention option, with a weighted composite average score for each. Bubble size represents the total weighted composite score.

```{r bubble_graph, echo=FALSE}

# Clean intervention names for display
results <- results %>%
  mutate(intervention_clean = str_replace_all(intervention, "_", " "))

# Use ggrepel

xmin <- min(results$feasibility)
xmax <- max(results$feasibility)
ymin <- min(results$impact)
ymax <- max(results$impact)

ggplot(results, aes(x = feasibility, y = impact, size = total_score)) +
  geom_point(alpha = 0.7, color = "steelblue") +
  geom_text_repel(aes(label = intervention_clean), size = 3, max.overlaps = 20) +
  # # ADD strategic quadrant labels
  # annotate("text", x = 18, y = 2, label = "Easy Wins", color = "red", fontface = "bold") +
  # annotate("text", x = 18, y = 18, label = "Strategic Priorities", color = "darkgreen", fontface = "bold") +
  # annotate("text", x = 2, y = 18, label = "High Effort", color = "orange", fontface = "bold") +
  # annotate("text", x = 2, y = 2, label = "Avoid", color = "grey", fontface = "bold") +
  scale_size_continuous(range = c(3, 10), name = "Total Score") +
  labs(title = "Strategic Investment Map: Impact vs Feasibility",
       subtitle = "Coordinates show STAKEHOLDER-WEIGHTED aggregates | Size = overall value",
       x = "Feasibility (Weighted Composite)", y = "Impact (Weighted Composite)") + 
  theme_minimal() +
  xlim(xmin, xmax) + ylim(ymin, ymax)
```

# Annex - what drives the scores

```{r scores, echo=FALSE}
weight_breakdown <- score_matrix %>%
  pivot_longer(cols = -objective, names_to = "intervention", values_to = "impact_score") %>%
  left_join(objective_weights, by = "objective") %>%
  mutate(weighted_impact = impact_score * weight/100)

ggplot(weight_breakdown, aes(x = intervention, y = weighted_impact, fill = objective)) +
  geom_col() +
  labs(title = "What Drives Each Intervention's Score?",
       subtitle = "Breakdown of weighted contributions by objective") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

